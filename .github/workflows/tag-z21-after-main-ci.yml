name: Tag z21-ui / z21-server after main CI

on:
  workflow_run:
    workflows: ["Main - Full CI + Sonar + Deploy homepage"]
    branches: [main]
    types: [completed]

jobs:
  tag:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: read
    steps:
      - name: Checkout main at the tested commit
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Find PR labels for this merge commit
        id: pr
        uses: actions/github-script@v8
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const sha = context.payload.workflow_run.head_sha;

            // Find PRs associated with this commit
            const prs = await github.rest.repos.listPullRequestsAssociatedWithCommit({
              owner, repo, commit_sha: sha
            });

            if (!prs.data.length) {
              core.setOutput('found', 'false');
              return;
            }

            // pick first PR (usually exactly one)
            const pr = prs.data[0];
            core.setOutput('found', 'true');
            core.setOutput('number', String(pr.number));
            core.setOutput('labels', JSON.stringify(pr.labels.map(l => l.name)));

      - name: Determine bumps from PR labels
        id: bumps
        if: steps.pr.outputs.found == 'true'
        run: |
          LABELS='${{ steps.pr.outputs.labels }}'
          echo "$LABELS" > labels.json

          extract_bump () {
            local comp="$1"
            local pattern="release:${comp}:(patch|minor|major)"
            local matches
            matches=$(cat labels.json | grep -oE "$pattern" | sort -u || true)
            local count
            count=$(echo "$matches" | sed '/^$/d' | wc -l | tr -d ' ')
            if [ "$count" -eq 0 ]; then
              echo ""
              return 0
            fi
            if [ "$count" -gt 1 ]; then
              echo "ERROR: multiple release labels for $comp: $matches"
              exit 1
            fi
            echo "$matches" | sed -E "s/^release:${comp}://"
          }

          UI_BUMP=$(extract_bump "z21-ui")
          SRV_BUMP=$(extract_bump "z21-server")

          echo "ui=$UI_BUMP" >> $GITHUB_OUTPUT
          echo "server=$SRV_BUMP" >> $GITHUB_OUTPUT

      - name: Tag z21-ui
        if: steps.bumps.outputs.ui != ''
        run: |
          git fetch --tags

          PREFIX="z21-ui@"
          LAST=$(git tag --list "${PREFIX}*" --sort=-v:refname | head -n 1)
          BASE="0.1.0"
          if [ -n "$LAST" ]; then BASE="${LAST#${PREFIX}}"; fi

          IFS='.' read -r MA MI PA <<< "$BASE"
          case "${{ steps.bumps.outputs.ui }}" in
            major) MA=$((MA+1)); MI=0; PA=0 ;;
            minor) MI=$((MI+1)); PA=0 ;;
            patch) PA=$((PA+1)) ;;
          esac

          TAG="${PREFIX}${MA}.${MI}.${PA}"
          git tag "$TAG"
          git push origin "$TAG"

      - name: Tag z21-server
        if: steps.bumps.outputs.server != ''
        run: |
          git fetch --tags

          PREFIX="z21-server@"
          LAST=$(git tag --list "${PREFIX}*" --sort=-v:refname | head -n 1)
          BASE="0.1.0"
          if [ -n "$LAST" ]; then BASE="${LAST#${PREFIX}}"; fi

          IFS='.' read -r MA MI PA <<< "$BASE"
          case "${{ steps.bumps.outputs.server }}" in
            major) MA=$((MA+1)); MI=0; PA=0 ;;
            minor) MI=$((MI+1)); PA=0 ;;
            patch) PA=$((PA+1)) ;;
          esac

          TAG="${PREFIX}${MA}.${MI}.${PA}"
          git tag "$TAG"
          git push origin "$TAG"
